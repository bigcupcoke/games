<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>breakout</title>
        <style media="screen">
            body {
                background-color: darkslategrey;
            }
            canvas {
                border: 1px solid gray;
            }
        </style>
    </head>
    <body>
        <canvas id="dj-canvas" width="500" height="400"></canvas>
        <script type="text/javascript">
            var log = console.log.bind(console)

            var imageFromPath = function(path) {
                var img = new Image()
                img.src = path
                return img
            }

            var Paddle = function() {
                var img = imageFromPath('paddle.png')
                // log('img', img)
                var o = {
                    img: img,
                    x: 100,
                    y: 300,
                    speed: 5,
                    leftDown: false,
                    rightDown: false,
                }

                o.moveLeft = function() {
                    o.x -= o.speed
                }

                o.moveRight = function() {
                    o.x += o.speed
                }

                o.collide = function(ball) {
                    var result = false
                    if (ball.y + ball.img.height > o.y) {
                        if (ball.x > o.x && ball.x < o.x + o.img.width) {
                            log('相撞')
                            result = true
                        }
                    }
                    return result
                }

                return o
            }

            var Ball = function() {
                var img = imageFromPath('ball.png')

                var o = {
                    img: img,
                    x: 100,
                    y: 280,
                    speedX: 5,
                    speedY: 5,
                    fired: false,
                }

                o.boundX = function() {
                    o.speedX *= -1
                }

                o.boundY = function() {
                    o.speedY *= -1
                }

                o.bound = function() {
                    o.boundX()
                    o.boundY()
                }

                o.move = function() {
                    if (o.fired) {
                        if (o.x < 0 || o.x > 500) {
                            o.boundX()
                        }
                        if (o.y < 0 || o.y > 400) {
                            o.boundY()
                        }
                        o.x += o.speedX
                        o.y += o.speedY
                    }
                }

                o.fire = function() {
                    o.fired = true
                }

                return o
            }

            var Game = function() {
                var g = {
                    actions: {},
                    keydowns: {
                        'a': false,
                        'd': false,
                    },
                    update: function() {},
                    draw: function() {},
                }

                var canvas = document.querySelector('#dj-canvas')
                var context = canvas.getContext('2d')

                g.canvas = canvas
                g.context = context

                g.drawImg = function(o) {
                    // log('o', this)
                    this.context.drawImage(o.img, o.x, o.y)
                }

                g.clear = function() {
                    this.context.clearRect(0, 0, canvas.width, canvas.height)
                }

                // change keydowns  state
                window.addEventListener('keydown', function(e) {
                    g.keydowns[e.key] = true
                })
                window.addEventListener('keyup', function(e) {
                    g.keydowns[e.key] = false
                })

                //  registerAction
                g.registerAction = function(key, callback) {
                    g.actions[key] = callback
                    log('cb', callback)
                }

                //  timer
                setInterval(function () {
                    var actions = Object.keys(g.actions)
                    actions.forEach(function(key) {
                        if (g.keydowns[key]) {
                            log('actions', g.actions[key])
                            g.actions[key]()
                        }
                    })

                    g.update()
                    // clear
                    g.clear()
                    //  draw
                    g.draw()
                }, 1000 / 60)

                return g
            }


            var __main = function() {
                var paddle = Paddle()

                var game = Game()
                 ball = Ball()

                game.registerAction('a', paddle.moveLeft)
                game.registerAction('d', paddle.moveRight)
                game.registerAction('f', ball.fire)

                game.update = function() {
                    ball.move()
                    if (paddle.collide(ball)) {
                        ball.bound()
                    }
                }

                game.draw = function() {
                    game.drawImg(paddle)
                    game.drawImg(ball)
                }
            }

             __main()
        </script>
    </body>
</html>
